{% extends "base.html" %}

{% block title %}编辑软件 - {{ site_settings.site_name }}{% endblock %}

{% block head %}
<style>
    .form-container {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 2rem;
        margin: 2rem 0;
    }

    .form-header {
        text-align: center;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border-color);
    }

    .form-title {
        font-size: 2rem;
        font-weight: bold;
        color: var(--text-bright);
        margin-bottom: 0.5rem;
    }

    .form-subtitle {
        color: var(--text-secondary);
        font-size: 1rem;
    }

    .form-section {
        background: var(--secondary-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    .section-title {
        color: var(--text-primary);
        font-weight: bold;
        margin-bottom: 1.5rem;
        font-size: 1.2rem;
    }

    .form-label {
        color: var(--text-bright);
        font-weight: 600;
        margin-bottom: 0.5rem;
        display: block;
    }

    .form-control, .form-select {
        background: var(--tertiary-bg);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
        border-radius: 4px;
        padding: 0.75rem;
    }

    .form-control:focus, .form-select:focus {
        background: var(--tertiary-bg);
        border-color: var(--primary-color);
        color: var(--text-primary);
        box-shadow: 0 0 0 0.2rem rgba(99, 102, 241, 0.25);
        outline: none;
    }

    .platform-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin-top: 0.5rem;
    }

    .platform-item {
        display: flex;
        align-items: center;
        background: var(--tertiary-bg);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        padding: 0.75rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .platform-item:hover {
        border-color: var(--primary-color);
    }

    .platform-item.selected {
        border-color: var(--primary-color);
        background: rgba(99, 102, 241, 0.1);
    }

    .platform-item input[type="checkbox"] {
        margin-right: 0.75rem;
        width: 18px;
        height: 18px;
    }

    .platform-item label {
        color: var(--text-primary);
        margin: 0;
        flex: 1;
        cursor: pointer;
    }

    .platform-icon {
        margin-right: 0.5rem;
        font-size: 1.2rem;
    }

    .current-images {
        margin-bottom: 1.5rem;
    }

    .current-images-title {
        color: var(--text-primary);
        font-weight: bold;
        margin-bottom: 1rem;
        font-size: 1rem;
    }

    .current-images-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .current-image-item {
        position: relative;
        border-radius: 4px;
        overflow: hidden;
        border: 1px solid var(--border-color);
        background: var(--secondary-bg);
    }

    .current-image-item img {
        width: 100%;
        height: 100px;
        object-fit: cover;
    }

    .current-image-remove {
        position: absolute;
        top: 5px;
        right: 5px;
        background: var(--danger-color);
        color: white;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 0.7rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .current-image-remove:hover {
        background: #dc2626;
    }

    .upload-area {
        border: 2px dashed var(--border-color);
        border-radius: 8px;
        padding: 2rem;
        text-align: center;
        background: var(--tertiary-bg);
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .upload-area:hover {
        border-color: var(--primary-color);
        background: rgba(99, 102, 241, 0.05);
    }

    .upload-area.dragover {
        border-color: var(--primary-color);
        background: rgba(99, 102, 241, 0.1);
    }

    .upload-icon {
        font-size: 2rem;
        color: var(--text-secondary);
        margin-bottom: 1rem;
    }

    .upload-text {
        color: var(--text-primary);
        margin-bottom: 0.5rem;
        font-weight: 600;
    }

    .upload-hint {
        color: var(--text-secondary);
        font-size: 0.9rem;
    }

    .preview-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }

    .preview-item {
        position: relative;
        border-radius: 4px;
        overflow: hidden;
        border: 1px solid var(--border-color);
        background: var(--secondary-bg);
    }

    .preview-item img {
        width: 100%;
        height: 100px;
        object-fit: cover;
    }

    .preview-remove {
        position: absolute;
        top: 5px;
        right: 5px;
        background: var(--danger-color);
        color: white;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 0.7rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .preview-remove:hover {
        background: #dc2626;
    }

    .download-section {
        margin-top: 1rem;
    }

    .download-platform {
        background: var(--tertiary-bg);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        padding: 1rem;
        margin-bottom: 1rem;
    }

    .platform-header {
        display: flex;
        align-items: center;
        margin-bottom: 1rem;
        color: var(--text-primary);
        font-weight: bold;
    }

    .download-type {
        margin-bottom: 1rem;
    }

    .download-type label {
        color: var(--text-secondary);
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
        display: block;
    }

    .current-file-info {
        background: var(--card-bg);
        border: 1px solid var(--primary-color);
        border-radius: 4px;
        padding: 0.5rem;
        margin-bottom: 0.5rem;
        font-size: 0.8rem;
        color: var(--text-secondary);
    }

    .custom-links {
        background: var(--secondary-bg);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        padding: 1rem;
        margin-top: 1rem;
    }

    .video-preview {
        margin-top: 1rem;
    }

    .video-preview-item {
        background: var(--secondary-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1rem;
        text-align: center;
    }

    .video-preview-item video {
        border-radius: 4px;
        margin-bottom: 1rem;
    }

    .video-info {
        text-align: left;
        margin-bottom: 1rem;
        color: var(--text-secondary);
        font-size: 0.9rem;
    }

    .video-info p {
        margin: 0.25rem 0;
    }

    .current-video {
        margin-bottom: 1rem;
    }

    .current-video-title {
        color: var(--text-secondary);
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
    }

    .current-video-item {
        background: var(--secondary-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1rem;
        text-align: center;
    }

    .video-actions {
        margin-top: 1rem;
    }

    .custom-link-item {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
        align-items: center;
    }

    .custom-link-item:last-child {
        margin-bottom: 0;
    }

    .custom-link-item input {
        flex: 1;
    }

    .custom-link-item .btn-remove {
        background: var(--danger-color);
        color: white;
        border: none;
        border-radius: 4px;
        padding: 0.5rem;
        cursor: pointer;
        min-width: 40px;
    }

    .btn-add-link {
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 4px;
        padding: 0.5rem 1rem;
        cursor: pointer;
        font-size: 0.9rem;
        margin-top: 0.5rem;
    }

    .btn {
        padding: 0.75rem 1.5rem;
        border-radius: 4px;
        font-weight: 500;
        border: none;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
    }

    .btn-primary {
        background: var(--primary-color);
        color: white;
    }

    .btn-secondary {
        background: var(--text-secondary);
        color: white;
    }

    .btn-danger {
        background: var(--danger-color);
        color: white;
    }

    .btn:hover {
        opacity: 0.9;
    }

    .form-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 2rem;
        padding-top: 2rem;
        border-top: 1px solid var(--border-color);
    }

    .back-btn {
        position: fixed;
        top: 120px;
        left: 2rem;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 4px;
        width: 50px;
        height: 50px;
        font-size: 1.2rem;
        cursor: pointer;
        z-index: 1000;
    }

    .back-btn:hover {
        background: #5b21b6;
    }

    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }

    .modal-content {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        max-width: 400px;
        width: 90%;
    }

    .modal-header {
        padding: 1.5rem 1.5rem 1rem;
        border-bottom: 1px solid var(--border-color);
    }

    .modal-header h4 {
        color: var(--text-primary);
        margin: 0;
        font-weight: bold;
    }

    .modal-body {
        padding: 1.5rem;
    }

    .modal-body p {
        color: var(--text-secondary);
        margin-bottom: 1rem;
    }

    .modal-footer {
        padding: 1rem 1.5rem 1.5rem;
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 1rem;
    }

    @media (max-width: 768px) {
        .form-container {
            padding: 1rem;
            margin: 1rem;
        }

        .platform-grid {
            grid-template-columns: 1fr;
        }

        .form-actions {
            flex-direction: column;
            gap: 1rem;
        }

        .back-btn {
            top: 100px;
            left: 1rem;
        }

        .custom-link-item {
            flex-direction: column;
            align-items: stretch;
        }
        
        /* 手机端表单优化 */
        .form-header {
            padding: 1rem 0;
            margin-bottom: 1.5rem;
        }
        
        .form-title {
            font-size: 1.5rem;
        }
        
        .form-section {
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .section-title {
            font-size: 1.1rem;
            margin-bottom: 1rem;
        }
        
        .form-control, .form-select {
            font-size: 16px !important; /* 防止iOS缩放 */
            padding: 0.875rem;
        }
        
        .platform-item {
            padding: 1rem;
            justify-content: center;
            text-align: center;
        }
        
        .platform-item input[type="checkbox"] {
            margin-right: 0.5rem;
        }
        
        .upload-area {
            padding: 1.5rem;
        }
        
        .upload-icon {
            font-size: 1.5rem;
        }
        
        .upload-text {
            font-size: 1rem;
        }
        
        .upload-hint {
            font-size: 0.85rem;
        }
        
        .preview-grid, .current-images-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }
        
        .download-platform {
            padding: 0.75rem;
            margin-bottom: 0.75rem;
        }
        
        .platform-header {
            font-size: 0.95rem;
        }
        
        .btn {
            padding: 0.875rem 1rem;
            font-size: 0.95rem;
        }
        
        .btn-add-link {
            width: 100%;
            margin-top: 0.75rem;
        }

        .custom-link-item input {
            margin-bottom: 0.5rem;
        }
        
        .custom-link-item .btn-remove {
            width: 100%;
            margin-top: 0.5rem;
        }
        
        .current-images-title {
            font-size: 1rem;
            margin-bottom: 0.75rem;
        }
        
        .current-image-item {
            position: relative;
        }
        
        .current-image-remove {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 25px;
            height: 25px;
            font-size: 0.8rem;
        }
        
        /* 删除确认模态框手机端优化 */
        .delete-modal-content {
            margin: 10% auto;
            max-width: 90%;
            padding: 1.5rem;
        }
        
        .delete-modal h3 {
            font-size: 1.2rem;
        }
        
        .delete-modal-actions {
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .delete-modal-actions .btn {
            width: 100%;
        }
    }

    /* 上传进度条样式 */
    .upload-progress-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 10000;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(5px);
    }

    .upload-progress-content {
        background: white;
        border-radius: 15px;
        padding: 0;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        overflow: hidden;
        animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: translateY(-50px) scale(0.9);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    .upload-progress-header {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
        padding: 1.5rem;
        text-align: center;
    }

    .upload-progress-header h3 {
        margin: 0;
        font-size: 1.3rem;
        font-weight: 600;
    }

    .upload-progress-body {
        padding: 2rem;
    }

    .progress-container {
        margin-bottom: 1.5rem;
    }

    .progress-bar-container {
        width: 100%;
        height: 12px;
        background: #f0f0f0;
        border-radius: 6px;
        overflow: hidden;
        margin-bottom: 0.75rem;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .progress-bar {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
        border-radius: 6px;
        transition: width 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .progress-bar::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        animation: progressShine 2s infinite;
    }

    @keyframes progressShine {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }

    .progress-text {
        text-align: center;
        font-weight: 600;
        color: var(--primary-color);
        font-size: 1.1rem;
    }

    .status-container {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 1rem;
        gap: 0.75rem;
    }

    .status-icon {
        font-size: 1.2rem;
        color: var(--primary-color);
    }

    .status-text {
        font-size: 1rem;
        color: #333;
        font-weight: 500;
    }

    .status-success {
        color: var(--success-color) !important;
    }

    .status-error {
        color: var(--danger-color) !important;
    }

    .progress-details {
        text-align: center;
        color: #666;
        font-size: 0.9rem;
        line-height: 1.4;
    }

    /* 移动端进度条优化 */
    @media (max-width: 768px) {
        .upload-progress-content {
            width: 95%;
            margin: 1rem;
        }

        .upload-progress-header {
            padding: 1.25rem;
        }

        .upload-progress-header h3 {
            font-size: 1.1rem;
        }

        .upload-progress-body {
            padding: 1.5rem;
        }

        .progress-text {
            font-size: 1rem;
        }

        .status-text {
            font-size: 0.9rem;
        }

        .progress-details {
            font-size: 0.85rem;
        }
    }
    
    @media (max-width: 576px) {
        .form-container {
            margin: 0.5rem;
            padding: 0.75rem;
        }
        
        .preview-grid, .current-images-grid {
            grid-template-columns: 1fr;
        }
        
        .form-actions .btn {
            font-size: 0.9rem;
            padding: 0.75rem;
        }
        
        .back-btn {
            width: 40px;
            height: 40px;
            font-size: 1rem;
        }
        
        .delete-modal-content {
            margin: 5% auto;
            padding: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<button class="back-btn" onclick="history.back()">
    <i class="fas fa-arrow-left"></i>
</button>

<div class="container">
    <div class="form-container">
        <div class="form-header">
            <h1 class="form-title">编辑作品</h1>
            <p class="form-subtitle">修改作品信息和配置</p>
        </div>

        <form method="POST" enctype="multipart/form-data" id="editSoftwareForm">
            <div class="form-section">
                <h3 class="section-title">基本信息</h3>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">作品名称 *</label>
                        <input type="text" class="form-control" name="name" 
                               value="{{ software.name }}" required placeholder="输入作品名称">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">作品ID *</label>
                        <input type="text" class="form-control" name="game_id" 
                               value="{{ software.game_id or '' }}" required
                               placeholder="如: mengyafarm (只能使用英文字母、数字、下划线)"
                               pattern="[a-zA-Z0-9_]+"
                               title="只能包含英文字母、数字和下划线">
                        <small class="form-text text-muted">用于生成下载链接，如：/download/mengyafarm/android</small>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">版本号 *</label>
                        <input type="text" class="form-control" name="version" 
                               value="{{ software.version }}" required placeholder="如: 1.0.0">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">作品分类 *</label>
                        <input type="text" class="form-control" name="category" 
                               value="{{ software.category }}" required
                               placeholder="请输入作品分类，如：游戏娱乐、系统工具等">
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">作者 *</label>
                        <input type="text" class="form-control" name="developer" 
                               value="{{ software.developer }}" required placeholder="作者名称">
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">作品描述 *</label>
                    <textarea class="form-control" name="description" rows="4" required
                              placeholder="详细描述作品的功能和特点">{{ software.description }}</textarea>
                </div>

                <div class="mb-3">
                    <label class="form-label">作品标签</label>
                    <input type="text" class="form-control" name="tags"
                           value="{% if software.tags %}{{ software.tags | join(', ') }}{% endif %}"
                           placeholder="用逗号分隔多个标签，如：作品,休闲,像素">
                    <small class="form-text text-muted">标签有助于用户搜索和分类</small>
                </div>

                <div class="mb-3">
                    <label class="form-label">系统要求</label>
                    <textarea class="form-control" name="system_requirements" rows="3"
                              placeholder="作品运行的系统要求">{{ software.system_requirements or '' }}</textarea>
                </div>

                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="download_disabled" id="downloadDisabled"
                               {% if software.download_disabled %}checked{% endif %}>
                        <label class="form-check-label" for="downloadDisabled">
                            <i class="fas fa-ban text-warning me-2"></i>禁用下载
                        </label>
                        <small class="form-text text-muted d-block mt-1">勾选后将在前端隐藏所有下载链接和按钮</small>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3 class="section-title">支持平台 *</h3>
                
                <div class="platform-grid">
                    <div class="platform-item {% if 'Windows' in software.platforms %}selected{% endif %}" onclick="togglePlatform('Windows')">
                        <input type="checkbox" id="windows" name="platforms" value="Windows"
                               {% if 'Windows' in software.platforms %}checked{% endif %}>
                        <label for="windows">
                            <i class="fab fa-windows platform-icon"></i>Windows
                        </label>
                    </div>
                    <div class="platform-item {% if 'macOS' in software.platforms %}selected{% endif %}" onclick="togglePlatform('macOS')">
                        <input type="checkbox" id="macos" name="platforms" value="macOS"
                               {% if 'macOS' in software.platforms %}checked{% endif %}>
                        <label for="macos">
                            <i class="fab fa-apple platform-icon"></i>macOS
                        </label>
                    </div>
                    <div class="platform-item {% if 'Linux' in software.platforms %}selected{% endif %}" onclick="togglePlatform('Linux')">
                        <input type="checkbox" id="linux" name="platforms" value="Linux"
                               {% if 'Linux' in software.platforms %}checked{% endif %}>
                        <label for="linux">
                            <i class="fab fa-linux platform-icon"></i>Linux
                        </label>
                    </div>
                    <div class="platform-item {% if 'Android' in software.platforms %}selected{% endif %}" onclick="togglePlatform('Android')">
                        <input type="checkbox" id="android" name="platforms" value="Android"
                               {% if 'Android' in software.platforms %}checked{% endif %}>
                        <label for="android">
                            <i class="fab fa-android platform-icon"></i>Android
                        </label>
                    </div>
                    <div class="platform-item {% if 'iOS' in software.platforms %}selected{% endif %}" onclick="togglePlatform('iOS')">
                        <input type="checkbox" id="ios" name="platforms" value="iOS"
                               {% if 'iOS' in software.platforms %}checked{% endif %}>
                        <label for="ios">
                            <i class="fab fa-app-store-ios platform-icon"></i>iOS
                        </label>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3 class="section-title">{{ site_settings.gallery_title }}</h3>

                {% if software.images %}
                <div class="current-images">
                    <div class="current-images-title">当前图片</div>
                    <div class="current-images-grid" id="currentImagesGrid">
                        {% for image in software.images %}
                            {% if image and image.strip() %}
                            <div class="current-image-item" data-image="{{ image }}">
                                <img src="{{ url_for('static', filename=image) }}" alt="作品截图">
                                <button type="button" class="current-image-remove" onclick="removeCurrentImage('{{ image }}', this.parentElement)">×</button>
                            </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                <!-- 图片管理选项 -->
                <div class="mb-3">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="add_watermark" id="addWatermark" checked>
                                <label class="form-check-label" for="addWatermark">
                                    <i class="fas fa-image text-info me-2"></i>添加水印
                                </label>
                                <small class="form-text text-muted d-block">为新上传的图片添加水印</small>
                            </div>
                        </div>
                        <div class="col-md-4" id="coverSelection" style="display: none;">
                            <label class="form-label">封面图片</label>
                            <select class="form-select" name="cover_image_index" id="coverImageIndex">
                                <option value="">选择封面图片</option>
                            </select>
                            <small class="form-text text-muted">选择作为封面的图片</small>
                        </div>
                        <div class="col-md-4" id="existingCoverSelection">
                            <label class="form-label">当前封面</label>
                            <select class="form-select" name="cover_image_select" id="coverImageSelect">
                                <option value="">选择现有图片作为封面</option>
                                {% for image in software.images %}
                                    {% if image and image.strip() %}
                                    <option value="{{ image }}" {% if software.cover_image == image %}selected{% endif %}>图片 {{ loop.index }}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                            <small class="form-text text-muted">从现有图片中选择封面</small>
                        </div>
                    </div>
                </div>

                <!-- 一键删除按钮 -->
                {% if software.images %}
                <div class="mb-3">
                    <button type="button" class="btn btn-warning btn-sm" onclick="deleteAllImages()">
                        <i class="fas fa-trash-alt me-2"></i>一键删除所有图片
                    </button>
                </div>
                {% endif %}

                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <div class="upload-text">点击或拖拽上传新图片</div>
                    <div class="upload-hint">支持 JPG、PNG 格式，最多10张</div>
                    <input type="file" id="images" name="images" multiple accept="image/*" style="display: none;">
                </div>
                
                <div id="imagePreview" class="preview-grid"></div>
                <input type="hidden" id="imagesToDelete" name="images_to_delete" value="">
                <input type="hidden" id="deleteAllImagesFlag" name="delete_all_images" value="">
            </div>

            <div class="form-section">
                <h3 class="section-title">作品视频</h3>

                {% if software.video %}
                <div class="current-video">
                    <div class="current-video-title">当前视频</div>
                    <div class="current-video-item">
                        <video controls style="max-width: 100%; max-height: 300px;">
                            <source src="{{ url_for('static', filename=software.video) }}" type="video/mp4">
                            您的浏览器不支持视频播放。
                        </video>
                        <div class="video-actions">
                            <button type="button" class="btn btn-danger btn-sm" onclick="removeCurrentVideo()">删除当前视频</button>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <div class="upload-area" id="videoUploadArea">
                    <div class="upload-icon">
                        <i class="fas fa-video"></i>
                    </div>
                    <div class="upload-text">点击或拖拽上传视频</div>
                    <div class="upload-hint">支持 MP4、WEBM、MOV 格式，单个文件</div>
                    <input type="file" id="video" name="video" accept="video/*" style="display: none;">
                </div>
                
                <div id="videoPreview" class="video-preview"></div>
                <input type="hidden" id="deleteVideo" name="delete_video" value="">
            </div>

            <div class="form-section">
                <h3 class="section-title">下载配置</h3>
                <div id="downloadSection" class="download-section"></div>
            </div>

            <div class="form-actions">
                <div>
                    <button type="button" class="btn btn-danger" onclick="confirmDelete()">
                        <i class="fas fa-trash me-2"></i>删除软件
                    </button>
                </div>
                <div>
                    <button type="button" class="btn btn-secondary me-2" onclick="resetForm()">
                        <i class="fas fa-undo me-2"></i>重置更改
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>保存更改
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<div id="deleteModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h4>确认删除</h4>
        </div>
        <div class="modal-body">
            <p>确定要删除软件 "<strong>{{ software.name }}</strong>" 吗？</p>
            <p style="color: var(--danger-color); font-size: 0.9rem;">此操作不可撤销！</p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeDeleteModal()">取消</button>
            <form method="POST" action="{{ url_for('admin_delete_software', software_id=software.id) }}" style="display: inline;">
                <button type="submit" class="btn btn-danger">确认删除</button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let imagesToDelete = [];
    let selectedFiles = [];
    let customLinkCounters = {};

    // 平台选择功能
    function togglePlatform(platform) {
        const checkbox = document.getElementById(platform.toLowerCase());
        const platformItem = checkbox.closest('.platform-item');
        
        checkbox.checked = !checkbox.checked;
        
        if (checkbox.checked) {
            platformItem.classList.add('selected');
        } else {
            platformItem.classList.remove('selected');
        }
        
        generateDownloadInputs();
    }

    // 图片上传功能
    const uploadArea = document.getElementById('uploadArea');
    const imageInput = document.getElementById('images');
    const imagePreview = document.getElementById('imagePreview');

    uploadArea.addEventListener('click', () => {
        imageInput.click();
    });

    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        
        const files = Array.from(e.dataTransfer.files);
        handleFiles(files);
    });

    imageInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        handleFiles(files);
    });

    function handleFiles(files) {
        const imageFiles = files.filter(file => file.type.startsWith('image/'));
        
        if (selectedFiles.length + imageFiles.length > 10) {
            alert('最多只能上传10张图片！');
            return;
        }

        imageFiles.forEach(file => {
            selectedFiles.push(file);
            displayImagePreview(file, selectedFiles.length - 1);
        });

        updateFileInput();
    }

    function displayImagePreview(file, index) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const previewItem = document.createElement('div');
            previewItem.className = 'preview-item';
            previewItem.innerHTML = `
                <img src="${e.target.result}" alt="预览图 ${index + 1}">
                <button type="button" class="preview-remove" onclick="removeImage(${index})">×</button>
            `;
            imagePreview.appendChild(previewItem);
        };
        reader.readAsDataURL(file);
    }

    function removeImage(index) {
        selectedFiles.splice(index, 1);
        updateImagePreview();
        updateFileInput();
    }

    function updateImagePreview() {
        imagePreview.innerHTML = '';
        selectedFiles.forEach((file, index) => {
            displayImagePreview(file, index);
        });
    }

    function updateFileInput() {
        const dt = new DataTransfer();
        selectedFiles.forEach(file => {
            dt.items.add(file);
        });
        imageInput.files = dt.files;
        updateCoverSelection();
    }

    // 更新封面选择选项
    function updateCoverSelection() {
        const coverSelection = document.getElementById('coverSelection');
        const coverSelect = document.getElementById('coverImageIndex');
        
        if (selectedFiles.length > 0) {
            coverSelection.style.display = 'block';
            
            // 清空现有选项
            coverSelect.innerHTML = '<option value="">选择封面图片</option>';
            
            // 添加新选项
            selectedFiles.forEach((file, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `第${index + 1}张图片 (${file.name})`;
                coverSelect.appendChild(option);
            });
        } else {
            coverSelection.style.display = 'none';
        }
    }

    // 一键删除所有图片
    function deleteAllImages() {
        if (confirm('确定要删除所有图片吗？此操作不可撤销！')) {
            document.getElementById('deleteAllImagesFlag').value = '1';
            document.getElementById('currentImagesGrid').style.display = 'none';
            document.querySelector('.current-images').style.display = 'none';
            
            // 清空新上传的图片
            selectedFiles = [];
            imagePreview.innerHTML = '';
            imageInput.value = '';
            updateCoverSelection();
            
            alert('所有图片将在保存时删除');
        }
    }

    // 删除现有图片
    function removeCurrentImage(imagePath, element) {
        if (confirm('确定要删除这张图片吗？')) {
            imagesToDelete.push(imagePath);
            document.getElementById('imagesToDelete').value = imagesToDelete.join(',');
            element.style.display = 'none';
            
            // 更新现有封面选择
            const coverSelect = document.getElementById('coverImageSelect');
            const optionToRemove = coverSelect.querySelector(`option[value="${imagePath}"]`);
            if (optionToRemove) {
                optionToRemove.remove();
            }
            
            // 如果删除的是当前封面，清空选择
            if (coverSelect.value === imagePath) {
                coverSelect.value = '';
            }
        }
    }

    // 视频上传功能
    const videoUploadArea = document.getElementById('videoUploadArea');
    const videoInput = document.getElementById('video');
    const videoPreview = document.getElementById('videoPreview');
    let selectedVideo = null;

    videoUploadArea.addEventListener('click', () => {
        videoInput.click();
    });

    videoUploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        videoUploadArea.classList.add('dragover');
    });

    videoUploadArea.addEventListener('dragleave', () => {
        videoUploadArea.classList.remove('dragover');
    });

    videoUploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        videoUploadArea.classList.remove('dragover');
        
        const files = Array.from(e.dataTransfer.files);
        handleVideoFiles(files);
    });

    videoInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        handleVideoFiles(files);
    });

    function handleVideoFiles(files) {
        const videoFiles = files.filter(file => file.type.startsWith('video/'));
        
        if (videoFiles.length === 0) {
            alert('请选择视频文件！');
            return;
        }

        if (videoFiles.length > 1) {
            alert('只能上传一个视频文件！');
            return;
        }

        const videoFile = videoFiles[0];
        selectedVideo = videoFile;
        displayVideoPreview(videoFile);
        updateVideoInput();
    }

    function displayVideoPreview(file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            videoPreview.innerHTML = `
                <div class="video-preview-item">
                    <video controls style="max-width: 100%; max-height: 300px;">
                        <source src="${e.target.result}" type="${file.type}">
                        您的浏览器不支持视频播放。
                    </video>
                    <div class="video-info">
                        <p><strong>文件名：</strong>${file.name}</p>
                        <p><strong>大小：</strong>${formatFileSize(file.size)}</p>
                        <p><strong>类型：</strong>${file.type}</p>
                    </div>
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeVideo()">删除视频</button>
                </div>
            `;
        };
        reader.readAsDataURL(file);
    }

    function removeVideo() {
        selectedVideo = null;
        videoPreview.innerHTML = '';
        videoInput.value = '';
    }

    function removeCurrentVideo() {
        if (confirm('确定要删除当前视频吗？')) {
            document.getElementById('deleteVideo').value = '1';
            document.querySelector('.current-video').style.display = 'none';
        }
    }

    function updateVideoInput() {
        if (selectedVideo) {
            const dt = new DataTransfer();
            dt.items.add(selectedVideo);
            videoInput.files = dt.files;
        }
    }

    function removeCurrentImage(imagePath, element) {
        if (confirm('确定要删除这张图片吗？')) {
            imagesToDelete.push(imagePath);
            document.getElementById('imagesToDelete').value = imagesToDelete.join(',');
            element.remove();
        }
    }

    // 动态生成下载配置
    function generateDownloadInputs() {
        const platforms = [];
        document.querySelectorAll('input[name="platforms"]:checked').forEach(checkbox => {
            platforms.push(checkbox.value);
        });

        const downloadSection = document.getElementById('downloadSection');
        downloadSection.innerHTML = '';

        if (platforms.length === 0) {
            downloadSection.innerHTML = '<p class="text-muted">请先选择支持的平台</p>';
            return;
        }

        const currentLinks = {{ software.download_links | tojson | safe }};
        const currentSizes = {{ software.file_sizes | tojson | safe }};

        platforms.forEach(platform => {
            if (!customLinkCounters[platform]) {
                customLinkCounters[platform] = 0;
            }

            const platformLinks = currentLinks[platform] || {};
            const platformSize = currentSizes[platform] || '';

            const platformDiv = document.createElement('div');
            platformDiv.className = 'download-platform';
            platformDiv.innerHTML = `
                <div class="platform-header">
                    <i class="fab fa-${platform.toLowerCase()} platform-icon"></i>${platform}
                    ${platformSize ? `<span style="margin-left: 0.5rem; color: var(--text-secondary); font-size: 0.9rem;">(${platformSize})</span>` : ''}
                </div>
                <div class="download-type">
                    <label>本地安装文件</label>
                    ${platformLinks.local ? `<div class="current-file-info"><i class="fas fa-file me-1"></i>当前文件已存在</div>` : ''}
                    <input type="file" class="form-control" 
                           name="install_file_${platform}" 
                           accept=".exe,.msi,.dmg,.pkg,.deb,.rpm,.appimage,.apk,.ipa,.zip,.tar.gz,.tar.bz2">
                    <small class="form-text text-muted">上传新文件将覆盖现有文件</small>
                </div>
                <div class="custom-links">
                    <label>自定义下载链接</label>
                    <div id="customLinks_${platform}">
                        <!-- 自定义链接将在这里生成 -->
                    </div>
                    <button type="button" class="btn-add-link" onclick="addCustomLink('${platform}')">
                        <i class="fas fa-plus me-1"></i>添加网盘链接
                    </button>
                </div>
            `;
            downloadSection.appendChild(platformDiv);

            // 添加现有的自定义链接
            Object.keys(platformLinks).forEach(linkType => {
                if (linkType !== 'local') {
                    addCustomLink(platform, linkType, platformLinks[linkType]);
                }
            });
        });
    }

    function addCustomLink(platform, existingName = '', existingUrl = '') {
        const container = document.getElementById(`customLinks_${platform}`);
        const index = customLinkCounters[platform]++;
        
        const linkItem = document.createElement('div');
        linkItem.className = 'custom-link-item';
        linkItem.innerHTML = `
            <input type="text" class="form-control" name="custom_name_${platform}" 
                   placeholder="网盘名称（如：百度网盘）" value="${existingName}">
            <input type="url" class="form-control" name="custom_url_${platform}" 
                   placeholder="下载链接" value="${existingUrl}">
            <button type="button" class="btn-remove" onclick="removeCustomLink(this)">
                <i class="fas fa-trash"></i>
            </button>
        `;
        
        container.appendChild(linkItem);
    }

    function removeCustomLink(button) {
        button.closest('.custom-link-item').remove();
    }

    function resetForm() {
        if (confirm('确定要重置所有更改吗？这将恢复到原始状态。')) {
            location.reload();
        }
    }

    function confirmDelete() {
        document.getElementById('deleteModal').style.display = 'flex';
    }

    function closeDeleteModal() {
        document.getElementById('deleteModal').style.display = 'none';
    }

    document.getElementById('deleteModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeDeleteModal();
        }
    });

    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeDeleteModal();
        }
    });

    // 表单提交验证
    document.getElementById('editSoftwareForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const platforms = document.querySelectorAll('input[name="platforms"]:checked');
        if (platforms.length === 0) {
            alert('请至少选择一个支持平台！');
            return;
        }

        const name = document.querySelector('input[name="name"]').value.trim();
        const version = document.querySelector('input[name="version"]').value.trim();
        const developer = document.querySelector('input[name="developer"]').value.trim();
        const category = document.querySelector('input[name="category"]').value;
        const description = document.querySelector('textarea[name="description"]').value.trim();

        if (!name || !version || !developer || !category || !description) {
            alert('请填写所有必填字段！');
            return;
        }

        // 开始上传
        submitFormWithProgress();
    });

    function submitFormWithProgress() {
        const form = document.getElementById('editSoftwareForm');
        const formData = new FormData(form);
        
        // 显示进度弹窗
        const progressModal = document.getElementById('uploadProgress');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const statusIcon = document.getElementById('statusIcon');
        const statusText = document.getElementById('statusText');
        const progressDetails = document.getElementById('progressDetails');
        
        progressModal.style.display = 'flex';
        
        // 创建XMLHttpRequest
        const xhr = new XMLHttpRequest();
        
        // 监听上传进度
        xhr.upload.addEventListener('progress', function(e) {
            if (e.lengthComputable) {
                const percentComplete = Math.round((e.loaded / e.total) * 100);
                
                progressBar.style.width = percentComplete + '%';
                progressText.textContent = `上传中... ${percentComplete}%`;
                
                if (percentComplete < 20) {
                    statusText.textContent = '正在上传图片文件...';
                    progressDetails.textContent = `已上传 ${formatFileSize(e.loaded)} / ${formatFileSize(e.total)}`;
                } else if (percentComplete < 40) {
                    statusText.textContent = '正在上传视频文件...';
                    progressDetails.textContent = `上传进度：${percentComplete}% 完成`;
                } else if (percentComplete < 80) {
                    statusText.textContent = '正在上传安装文件...';
                    progressDetails.textContent = `上传进度：${percentComplete}% 完成`;
                } else if (percentComplete < 95) {
                    statusText.textContent = '正在处理文件...';
                    progressDetails.textContent = '服务器正在处理上传的文件...';
                } else {
                    statusText.textContent = '正在处理图片...';
                    progressDetails.textContent = '正在压缩图片并添加水印，请稍候...';
                }
            }
        });
        
        // 监听上传完成
        xhr.addEventListener('load', function() {
            if (xhr.status === 200) {
                // 显示图片处理完成
                progressBar.style.width = '100%';
                progressText.textContent = '处理完成！100%';
                statusText.textContent = '图片处理完成';
                progressDetails.textContent = '图片压缩和水印添加完成，正在保存...';
                
                // 短暂延迟后显示成功
                setTimeout(() => {
                    statusIcon.style.display = 'none';
                    statusText.innerHTML = '<i class="fas fa-check-circle status-success me-2"></i>作品更新成功！';
                    progressDetails.textContent = '正在跳转到管理页面...';
                    
                    // 延迟跳转
                    setTimeout(() => {
                        window.location.href = '/admin?token=lcxm1314520';
                    }, 2000);
                }, 1000);
            } else {
                // 上传失败
                showUploadError('上传失败，请检查网络连接或稍后重试');
            }
        });
        
        // 监听上传错误
        xhr.addEventListener('error', function() {
            showUploadError('网络错误，请检查网络连接');
        });
        
        // 监听上传超时
        xhr.addEventListener('timeout', function() {
            showUploadError('上传超时，请检查网络连接或重试');
        });
        
        // 设置超时时间（5分钟）
        xhr.timeout = 300000;
        
        // 发送请求
        xhr.open('POST', form.action || window.location.pathname);
        xhr.send(formData);
    }
    
    function showUploadError(message) {
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const statusIcon = document.getElementById('statusIcon');
        const statusText = document.getElementById('statusText');
        const progressDetails = document.getElementById('progressDetails');
        
        progressBar.style.background = 'var(--danger-color)';
        progressText.textContent = '上传失败';
        statusIcon.style.display = 'none';
        statusText.innerHTML = '<i class="fas fa-times-circle status-error me-2"></i>' + message;
        progressDetails.innerHTML = `
            <button onclick="closeProgressModal()" class="btn btn-secondary me-2">关闭</button>
            <button onclick="retryUpload()" class="btn btn-primary">重试</button>
        `;
    }
    
    function closeProgressModal() {
        document.getElementById('uploadProgress').style.display = 'none';
        // 恢复进度条状态
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const statusIcon = document.getElementById('statusIcon');
        const statusText = document.getElementById('statusText');
        const progressDetails = document.getElementById('progressDetails');
        
        progressBar.style.width = '0%';
        progressBar.style.background = 'linear-gradient(90deg, var(--primary-color), var(--secondary-color))';
        progressText.textContent = '准备上传... 0%';
        statusIcon.style.display = 'block';
        statusText.textContent = '正在处理文件...';
        progressDetails.textContent = '请稍候，正在上传文件到服务器...';
    }
    
    function retryUpload() {
        closeProgressModal();
        setTimeout(() => {
            submitFormWithProgress();
        }, 500);
    }
    
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // 初始化
    document.addEventListener('DOMContentLoaded', function() {
        generateDownloadInputs();
    });
</script>

<!-- 上传进度弹窗 -->
<div id="uploadProgress" class="upload-progress-modal">
    <div class="upload-progress-content">
        <div class="upload-progress-header">
            <h3><i class="fas fa-cloud-upload-alt me-2"></i>正在更新作品</h3>
        </div>
        <div class="upload-progress-body">
            <div class="progress-container">
                <div class="progress-bar-container">
                    <div id="progressBar" class="progress-bar"></div>
                </div>
                <div id="progressText" class="progress-text">准备上传... 0%</div>
            </div>
            <div class="status-container">
                <div id="statusIcon" class="status-icon">
                    <i class="fas fa-spinner fa-spin"></i>
                </div>
                <div id="statusText" class="status-text">正在处理文件...</div>
            </div>
            <div id="progressDetails" class="progress-details">
                请稍候，正在上传文件到服务器...
            </div>
        </div>
    </div>
</div>

{% endblock %}